version: 2.1

jobs:
  build:
    machine: 
      image: ubuntu-2004:202010-01
      docker_layer_caching: true
    environment:
      NAME: moodwalk/moodwork-docker-images/base-image
      BASE_IMAGE: ubuntu:20.04
      PLATFORM: amd64
      QEMU_ARCH: amd64 
      TAG_ARCH: amd64
    steps:
      - checkout
      - run: 
          name: Authenticate on Image Registry
          command: |
            docker login -u moodworkdevops -p $DOCKERHUB_REGISTRY
      - run: 
          name: "Build moodwork docker image"
          command: |
            VERSION=${CIRCLE_BRANCH} make build
            VERSION=${CIRCLE_BRANCH} make tag_latest
      - run:
          name: Push to store
          command: |
            docker push $NAME:latest-${TAG_ARCH}

workflows:
  version: 2
  # nightly:
  #   triggers:
  #     - schedule:
  #         cron: "0 0 * * *"
  #         filters:
  #           branches:
  #             only:
  #               - master
  #   jobs:
  #     - build:
  #         context: docker               
  build:
    jobs:
      - build:
          context: docker
          filters:
            branches:
              only:
                - master
                - feature/dockerhub
